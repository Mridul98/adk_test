## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.dxp_data_mom_yoy

## Overview  
This model aggregates monthly customer activity and performance metrics from multiple source tables, computes month‑over‑month and year‑over‑year changes, and provides rolling 12‑month averages for pageviews, transactions, site availability, response time, and low‑priority CMS tickets.

## Tables Involved  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_appinsights_metrics`: raw daily pageview metrics.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_b2c_transactions`: raw daily transaction metrics.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_organizational_metrics`: raw daily site performance metrics.  
- `Reporting.Zendesk.Tickets`: Zendesk ticket records.

## Columns Used  

**TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_appinsights_metrics**  
- `Master_customer_id` – Customer identifier.  
- `Metrics_date` – Date of the metric.  
- `Pageviews` – Number of pageviews for the day.  

**TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_b2c_transactions**  
- `Master_customer_id` – Customer identifier.  
- `Metrics_date` – Date of the metric.  
- `Transactions` – Number of transactions for the day.  

**TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_organizational_metrics**  
- `Master_customer_id` – Customer identifier.  
- `Metrics_date` – Date of the metric.  
- `Pd_reported_downtime_percentage` – Downtime percentage reported.  
- `Pd_average_response_time_ms` – Average response time in milliseconds.  

**Reporting.Zendesk.Tickets**  
- `Master_customer_id` – Customer identifier.  
- `Created_at` – Ticket creation timestamp.  
- `Id` – Ticket identifier.  
- `Priority` – Ticket priority.  
- `Tag_list` – Comma‑separated list of tags.  
- `Ticket_product` – Product associated with the ticket.  

**Derived.Combineddata**  
- `Master_customer_id` – Customer identifier (from any source).  
- `Year_month` – Month in `YYYY-MM` format (derived from the earliest available date).  
- `Is_current_month` – Boolean flag if the row is for the current month.  
- `Pageviews` – Monthly total pageviews.  
- `Pageviews_mom` – Previous month’s pageviews.  
- `Pageviews_mom_change` – % change from previous month.  
- `Pageviews_yoy` – Pageviews 12 months ago.  
- `Pageviews_yoy_change` – % change from 12 months ago.  
- `Pageviews_12m_avg` – Rolling 12‑month average pageviews.  
- `Transactions` – Monthly total transactions.  
- `Transactions_mom` – Previous month’s transactions.  
- `Transactions_mom_change` – % change from previous month.  
- `Transactions_yoy` – Transactions 12 months ago.  
- `Transactions_yoy_change` – % change from 12 months ago.  
- `Transactions_12m_avg` – Rolling 12‑month average transactions.  
- `Site_availability_percentage` – Monthly site availability percentage.  
- `Site_availability_percentage_mom` – Previous month’s availability.  
- `Site_availability_percentage_mom_change` – % change from previous month.  
- `Site_availability_percentage_yoy` – Availability 12 months ago.  
- `Site_availability_percentage_yoy_change` – % change from 12 months ago.  
- `Site_availability_12m_avg` – Rolling 12‑month average availability.  
- `Response_time` – Monthly average response time (ms).  
- `Response_time_mom` – Previous month’s response time.  
- `Response_time_mom_change` – % change from previous month.  
- `Response_time_yoy` – Response time 12 months ago.  
- `Response_time_yoy_change` – % change from 12 months ago.  
- `Response_time_12m_avg` – Rolling 12‑month average response time.  
- `P4_tickets` – Monthly count of low‑priority CMS tickets.  
- `P4_tickets_mom` – Previous month’s ticket count.  
- `P4_tickets_mom_change` – % change from previous month.  
- `P4_tickets_yoy` – Ticket count 12 months ago.  
- `P4_tickets_yoy_change` – % change from 12 months ago.  
- `Ticket_count_12m_avg` – Rolling 12‑month average ticket count.  

## Logic Explanation  

1. **Pageviews CTE** – Aggregates daily pageview data by customer and month.  
   - `Year_month` is derived from `Metrics_date`.  
   - Calculates total pageviews, distinct customer count, average usage per customer, and a 12‑month rolling average using a window function partitioned by customer and ordered by month.

2. **Transactions CTE** – Similar aggregation for daily transaction data.  
   - Uses the same window logic for 12‑month averages.

3. **Monthlymetrics CTE** – Aggregates monthly site performance metrics.  
   - Computes site availability as `100 - avg(downtime_percentage)` and average response time.  
   - Calculates 12‑month rolling averages for both metrics.

4. **Monthlyticketcounts CTE** – Counts low‑priority CMS tickets per customer per month.  
   - Filters tickets by priority, excludes internal/duplicate/spam tags, and ensures the product contains “CMS”.  
   - Uses a 12‑month rolling average of ticket counts.

5. **Combineddata CTE** – Performs a full outer join across the four monthly CTEs on `Master_customer_id` and `Year_month`.  
   - Uses `COALESCE` to pick the available month value when some CTEs lack data for a given month.  
   - Calculates month‑over‑month (MoM) and year‑over‑year (YoY) differences for each metric using `LAG` window functions.  
   - Formats percentage changes with two or four decimal places and appends a `%` sign.  
   - Includes the 12‑month rolling averages from each source CTE.

6. **Final SELECT** – Returns all columns from `Combineddata`, ordered by `Master_customer_id` ascending and `Year_month` descending.

## Grain of Data  
The final result set is at the **customer‑month** level, providing one row per `Master_customer_id` for each month for which any of the source metrics exist.
