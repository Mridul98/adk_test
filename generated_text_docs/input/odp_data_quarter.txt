## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.odp_data_quarter

## Overview  
This model aggregates quarterly usage and health indicator metrics for non‑ODP organizations starting from August 2022. It produces a single table that lists, per quarter, the number of unique customers, unique views, monthly active users, total segments, and total real‑time segments.

## Tables Involved  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage`: source of usage metrics.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report`: source of segment counts.

## Columns Used  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.period_start` – start date of the metric period.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.master_customer_id` – customer identifier.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.uvs` – unique views.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.maus` – monthly active users.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.organization_name` – organization name (used for filtering).  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_odp_v2.stg_odp_v2_metric_usage.organization_id` – organization identifier.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.organization_id` – organization identifier.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.organization_name` – organization name.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.crm_id` – CRM identifier.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.period_start` – start of the health indicator period.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.period_end` – end of the health indicator period.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.segment_count` – number of segments.  
- `REPORTING_DEV.DBT_MAHMUDNABI_odp.health_indicators_report.real_time_segment_count` – number of real‑time segments.  
- Derived column `year_quarter` – concatenation of year and quarter from `period_start`.

## Logic Explanation  
1. **CTE `subq1`**  
   - Filters `stg_odp_v2_metric_usage` for records where `period_start` ≥ 2022‑08‑01 and `organization_name` does not contain “ODP”.  
   - Groups rows by fiscal quarter (`YEAR(period_start)` + `QUARTER(period_start)`).  
   - Calculates:  
     - `mcid`: distinct count of `master_customer_id`.  
     - `unique_views`: sum of `uvs`.  
     - `monthly_active_users`: sum of `maus`.  
   - Orders results by `year_quarter` descending.

2. **CTE `subq2`**  
   - Uses the same filtered `stg_odp_v2_metric_usage` dataset.  
   - For each row, performs two correlated subqueries:  
     - **Segments**:  
       - Aggregates `health_indicators_report` by organization and period, summing `segment_count`.  
       - For the current `odp_metric_usage` row, selects the maximum `segment_count` from the aggregated set where the report period covers the metric `period_start` and the organization IDs match.  
       - Sums these maximum values across all rows in the quarter.  
     - **Real‑time segments**: analogous logic using `real_time_segment_count`.  
   - Groups by fiscal quarter and orders by `year_quarter` descending.

3. **Final SELECT**  
   - Performs a left join of `subq1` and `subq2` on `year_quarter`, ensuring all quarters from `subq1` appear even if no matching health indicator data exists.  
   - Orders the final result by `subq1.year_quarter` descending.

## Grain of Data  
The output is aggregated at the **quarterly** level, providing one row per fiscal quarter with cumulative metrics for that period.
