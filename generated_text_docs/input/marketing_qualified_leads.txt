## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.marketing_qualified_leads

## Overview  
This model consolidates Salesforce qualified lead, opportunity, opportunity line item, contact, user, and account data with external GTM analytics tables to produce a detailed view of each qualified lead and its associated opportunity and product information. The result is one row per qualified lead per opportunity line item, enriched with calculated fields and business‑level categorizations.

## Tables Involved  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_qualified_lead`: source of qualified lead records.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity`: source of opportunity records.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity_line_item`: source of opportunity line items.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_quote_line`: quote line data used for pricing.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_subscription`: subscription data used for pricing adjustments.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact`: source of contact records.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users`: source of user records.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role`: source of user role names.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account`: source of account records.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_territory`: source of territory lookup.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_hierarchies`: lookup for region hierarchy.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_source_category`: lookup for lead source bucket.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.mql_type_category`: lookup for MQL type category.

## Columns Used  

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_qualified_lead  
- `qualified_lead_id` – unique identifier for the qualified lead.  
- `owner_id` – user who owns the lead.  
- `contact_id` – associated contact.  
- `opportunity_id` – associated opportunity.  
- `qualified_lead_name` – name of the lead.  
- `type_of_mql` – marketing qualified lead type.  
- `disqualified_reason` – reason for disqualification.  
- `recycled_reason` – reason for recycling.  
- `date_status_qualified` – date lead became qualified.  
- `status` – current status of the lead.  
- `date_status_spl` – date status changed to SPL.  
- `date_status_sal` – date status changed to SAL.  
- `date_status_sql` – date status changed to SQL.  
- `date_status_opportunity` – date status changed to Opportunity.  
- `date_status_customer` – date status changed to Customer.  
- `date_status_recycled` – date status changed to Recycled.  
- `date_status_disqualified` – date status changed to Disqualified.  
- `mql_campaign` – campaign associated with the MQL.  
- `mql_channel` – channel through which the MQL was generated.  
- `primary_product_of_interest` – main product the lead is interested in.  
- `last_touch_mql` – last touchpoint for the MQL.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity  
- `opportunity_id` – unique identifier for the opportunity.  
- `last_lead_source` – source of the last lead.  
- `stage_name` – current stage of the opportunity.  
- `date_entered_stage_accepted` – date entered Accepted stage.  
- `date_entered_stage_closed_lost` – date entered Closed‑Lost stage.  
- `date_entered_stage_closed_won` – date entered Closed‑Won stage.  
- `date_entered_stage_closed_won_finance` – date entered Closed‑Won‑Finance stage.  
- `date_entered_stage_contracts` – date entered Contracts stage.  
- `date_entered_stage_discovery` – date entered Discovery stage.  
- `date_entered_stage_proof_of_value` – date entered Proof‑of‑Value stage.  
- `date_entered_stage_sql_c` (aliased `date_entered_stage_sql`) – date entered SQL stage.  
- `date_entered_stage_proposal` – date entered Proposal stage.  
- `reason_lost_detail_c` (aliased `reason_lost_detail`) – detail of lost reason.  
- `opportunity_product_of_interest_2_c` (aliased `product_of_interest`) – product of interest.  
- `historical_current_contract_software_c` – historical contract amount.  
- `recurring_software_amount_new_rollup_c` – new roll‑up recurring amount.  
- `current_contract_software_new_c` – current contract amount.  
- `price_increase_software` – price increase amount.  
- `is_closed` – flag indicating if the opportunity is closed.  
- `close_date` – date the opportunity was closed.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity_line_item  
- `id` (aliased `opportunity_line_id`) – unique identifier for the line item.  
- `opportunity_id` – parent opportunity.  
- `qline.net_unit_price` – net unit price from quote line.  
- `oli.historical_current_subscription_software` – historical subscription amount.  
- `oli.subscription_term_calculated` – calculated subscription term.  
- `oli.exclude_from_1st_year_mrr` – flag for excluding from first‑year MRR.  
- `oli.total_price` – total price of the line item.  
- `subs.cpi_adjustments` – CPI adjustment factor.  
- `subs.original_price_renewal` – original renewal price.  
- Calculated fields: `annual_price`, `annual_price_increase`, `original_annual_price_renewal`, `recurring_software_amount_change`.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact  
- `id` (aliased `contact_id`) – unique identifier for the contact.  
- `name` (aliased `contact_name`) – contact name.  
- `lead_source` – source of the lead.  
- `lead_source_type_c` (aliased `lead_source_type`) – type of lead source.  
- `territory_text_c` (aliased `territory`) – territory text.  
- `email` – contact email.  
- `phone` – contact phone.  
- `account_id` – associated account.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users  
- `id` (aliased `user_id`) – unique identifier for the user.  
- `name` (aliased `user_name`) – user name.  

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role  
- `name` (aliased `user_role_name`) – name of the user role.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account  
- `account_id` – unique identifier for the account.  
- `account_name` – name of the account.  
- `territory` (aliased `territory_id`) – territory identifier.  
- `territory_name` – name of the territory.  
- `number_of_employees` – employee count.  
- `employee_count` – employee count (duplicate).  
- `segment` – business segment.  
- `icp_account` – ICP account classification.  
- `icp_account_archive` – archived ICP account.  
- `is_google_optimize` – flag for Google Optimize.  
- Calculated field: `icp_solution` via CASE logic.

### TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_territory  
- `id` – territory identifier.  
- `name` – territory name.  

### TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_hierarchies  
- `territory_name` – territory name for lookup.  
- `region_mql` – region for MQL.  
- `region` – parent region.

### TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_source_category  
- `opportunity_source` – source of the opportunity.  

### TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.mql_type_category  
- `type_of_mql` – MQL type.  
- `type_of_mql_category` – category of the MQL type.

## Logic Explanation  

1. **sf_qualified_lead** – Filters the qualified lead staging table for non‑deleted records and selects core lead attributes.  
2. **sf_opportunity** – Filters the opportunity staging table for non‑deleted records. Calculates `opportunity_rsac` as the difference between the new roll‑up recurring amount and either the historical contract amount or the sum of current contract and price increase, depending on data availability.  
3. **sf_opportunity_line_item** – Filters the opportunity line item staging table for non‑deleted records. Joins to quote line and subscription tables to enrich pricing data. Calculates:  
   - `annual_price` – prorated annual price unless excluded from first‑year MRR.  
   - `annual_price_increase` – CPI‑adjusted increase.  
   - `original_annual_price_renewal` – original renewal price adjusted for term.  
   - `recurring_software_amount_change` – change in recurring amount relative to historical or renewal values.  
4. **sf_contact** – Filters the contact staging table for non‑deleted records and selects contact details.  
5. **sf_user** – Joins users to their roles, selecting user name and role name.  
6. **sf_account** – Filters the account staging table for non‑deleted territories, joins to territory lookup, and derives `icp_solution` via a CASE mapping of ICP account values.  
7. **Final SELECT** – Performs left joins from qualified lead to opportunity, opportunity line item, contact, user, account, territory hierarchy, opportunity source category, and MQL type category. Adds derived columns:  
   - `qualified_lead_link` – URL to the lead record.  
   - `type_of_mql_category` – category of the MQL type, defaulting to `'z_Others'` if missing.  
   - `segment` – business segment derived from employee count.  
   - `region` and `parent_region` – from territory hierarchy.  
   - `lead_source_bucket` – bucketed lead source from opportunity source category.  
   The query filters out rows where the contact is missing (`sf_contact.contact_id IS NOT NULL`).

## Grain of Data  
The result set is at the **qualified lead × opportunity line item** level; each row represents a unique combination of a qualified lead and one of its associated opportunity line items, enriched with related opportunity, contact, user, account, and analytics data.
