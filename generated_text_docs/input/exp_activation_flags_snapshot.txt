## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.exp_activation_flags_snapshot

## Overview  
This model aggregates experiment start counts for each customer across multiple time windows (all‑time, last 7, 30, and 90 days) and combines them with ARR metrics to produce a weekly snapshot of experimentation activity and revenue for each Salesforce account.

## Tables Involved  
- **REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics**: experiment start data.  
- **REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail**: customer to Salesforce account mapping.  
- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account**: Salesforce account details.  
- **REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report**: ARR data for experimentation products.

## Columns Used  

**REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics**  
- `customer_id` – identifier of the customer.  
- `experiment_id` – unique experiment identifier.  
- `experiment_start_time_impressions_reached` – timestamp when the experiment started.

**REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail**  
- `customer_id` – customer key.  
- `salesforce_account_id` – Salesforce account identifier.  
- `master_customer_id` – customer identifier used in other tables (mcid).

**TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account**  
- `account_id` – Salesforce account identifier.  
- `master_customer_id` – customer identifier (mcid).  
- `account_name` – name of the account.  
- `customer_stage` – stage of the customer.

**REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report**  
- `mcid` – customer identifier.  
- `snapshot_date` – date of the ARR snapshot.  
- `arr_usd_ccfx` – ARR amount in USD.  
- `updated_product_group` – product group (used to filter for experimentation products).

**Derived / Calculated Columns**  
- `snapshot_date` – weekly snapshot date generated in `generated_weeks`.  
- `snapshot_month` – last day of the month for each snapshot date.  
- `earliest_exp_tat_date` – earliest ARR snapshot date per mcid.  
- `months_since_first_exp_product_identified_in_tat` – months between earliest ARR date and current date.  
- `arr` – current or latest ARR amount per mcid.

## Logic Explanation  
1. **generated_weeks** – For every customer in `experiment_metrics`, generate a list of weekly snapshot dates from 2024‑05‑01 to the current date.  
2. **exp_metrics_all_time** – Join `experiment_metrics` with `generated_weeks` and count distinct `experiment_id` where the experiment start time is on or before the snapshot date.  
3. **exp_metrics_last_7 / last_30 / last_90** – Similar to step 2 but restrict the start time to the last 7, 30, or 90 days relative to the snapshot date.  
4. **experiments_started_all_time** – Left‑join `oa_customer_detail` and `stg_opti_salesforce_account` to the all‑time metrics, aggregate counts per customer per snapshot date, compute `snapshot_month`, and flag customers that started fewer than 10 experiments.  
5. **experiments_started_last_7_days / last_30_days / last_90_days** – Repeat step 4 for the 7‑, 30‑, and 90‑day metrics, producing counts and flags for each period.  
6. **first_arr** – From `arr_report`, find the earliest snapshot date per mcid for product groups “Web Experimentation” or “Feature Experimentation”.  
7. **last_arr** – Sum `arr_usd_ccfx` per mcid for the most recent snapshot date across all records.  
8. **current_arr** – Sum `arr_usd_ccfx` per mcid per snapshot date.  
9. **final_dataset** – Left‑join all the above aggregates on `mcid` and `snapshot_date` (or `snapshot_month` for ARR), compute `months_since_first_exp_product_identified_in_tat`, and coalesce the ARR value to the current or latest amount.  
10. **Final SELECT** – Output the combined metrics, applying `COALESCE` defaults for nulls, and filter out rows where `mcid`, `salesforce_account_id`, or `snapshot_date` are null.

## Grain of Data  
The result set is at the **weekly level per customer (mcid)**, providing one row for each customer for each snapshot week.
