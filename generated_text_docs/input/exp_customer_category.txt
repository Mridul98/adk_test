## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.exp_customer_category

## Overview  
This model aggregates experiment and feature‑flag activity at the master‑customer level, categorizing experiment types, computing the proportion of experiments per category, summarizing owned digital‑optimization SKUs, and reporting counts of created, activated, and enabled feature flags.

## Tables Involved  
- `REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.exp_total_experiments_started_flags`: master‑customer experiment start data.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail`: mapping between master and customer IDs.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics`: detailed experiment metrics per customer.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics_historical`: historical feature‑flag metrics.  
- `REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report`: SKU ownership snapshots.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics`: current feature‑flag metrics.

## Columns Used  

### REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.exp_total_experiments_started_flags  
- `mcid` – Master customer identifier.  
- `experiment_id` – Unique experiment identifier.  
- `experiment_start_time_impressions_reached` – Timestamp when experiment reached impressions threshold.  
- `latest_exp_tat_date` – Latest experiment turnaround date (used for SKU ownership join).  

### REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail  
- `master_customer_id` – Master customer identifier (join key).  
- `customer_id` – Customer identifier (join key).  

### REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics  
- `customer_id` – Customer identifier (join key).  
- `experiment_classification` – Original experiment classification.  
- `experiment_id` – Unique experiment identifier (used for counting).  

### REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics_historical  
- `master_customer_id` – Master customer identifier (join key).  
- `feature_flag_id` – Unique feature‑flag identifier.  
- `flag_activate` – Timestamp of flag activation.  
- `flag_created` – Timestamp of flag creation.  
- `feature_flag_status` – Boolean flag status.  

### REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report  
- `mcid` – Master customer identifier (join key).  
- `updated_product_group` – SKU group name (e.g., “Feature Experimentation”).  
- `snapshot_date` – Snapshot date (used to match experiment start date).  

### REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics  
- `master_customer_id` – Master customer identifier (join key).  
- `feature_flag_id` – Unique feature‑flag identifier.  
- `flag_created` – Timestamp of flag creation.  
- `flag_activate` – Timestamp of flag activation.  
- `feature_flag_status` – Boolean flag status.  

### Derived / Calculated Columns  
- `experiment_classification` (exp_started_classification) – Mapped classification (e.g., “Feature Mangement”, “Experiment”).  
- `number_of_experiments` – Count of distinct experiments or feature flags per classification.  
- `classification_row_number` – Row number per `mcid` ordered by `number_of_experiments` descending.  
- `total_experiments` – Sum of `number_of_experiments` per `mcid`.  
- `products_owned_list` – Comma‑separated list of distinct `updated_product_group` values per `mcid`.  
- `feature_flags_created`, `feature_flags_activate`, `feature_flags_enabled` – Counts of feature flags per status.  
- `percent_experiment_main`, `percent_experiment_2`, `percent_experiment_3` – Proportion of experiments in each classification relative to total.  
- `customer_breakdown` – Human‑readable label combining classification and SKU ownership.  
- `skus_owned` – Label describing SKU ownership type.  
- `customer_category` – Label indicating whether the customer is a Feature Management customer with only FX SKU.  
- `customer_breakdown_sub_category` – Sub‑category label based on `percent_experiment_main` and `customer_breakdown`.  

## Logic Explanation  

1. **exp_started_classification** –  
   - Joins `exp_total_experiments_started_flags` → `oa_customer_detail` → `experiment_metrics`.  
   - Filters experiments that have reached impressions (`experiment_start_time_impressions_reached IS NOT NULL`).  
   - Maps the original `experiment_classification` to broader categories (e.g., “Feature Mangement”, “Experiment”).  
   - Counts distinct `experiment_id` per `mcid` and mapped classification.

2. **flags_enabled** –  
   - Uses `feature_flags_metrics_historical` joined to `exp_total_experiments_started_flags` on `master_customer_id`.  
   - Determines `flag_activate` as either the explicit activation timestamp or, if missing, the creation timestamp when the flag status is true.  
   - Filters rows where `flag_activate` is present.  
   - Counts distinct `feature_flag_id` per `mcid` (classification hard‑coded as “Feature Management”).

3. **combined** –  
   - Unions the two previous result sets.  
   - Adds a row number per `mcid` ordered by `number_of_experiments` descending, producing `classification_row_number` to rank classifications.

4. **total_experiments** –  
   - Aggregates `number_of_experiments` across all classifications per `mcid`, yielding the total experiments count.

5. **digital_optimization_sku_owned** –  
   - Joins `exp_total_experiments_started_flags` to `arr_report` on `mcid` and matching `latest_exp_tat_date` to `snapshot_date`.  
   - Filters for SKU groups of interest.  
   - Aggregates distinct `updated_product_group` values into a comma‑separated list per `mcid` and `latest_exp_tat_date`.

6. **flags_counts** –  
   - Joins `feature_flags_metrics` to `exp_total_experiments_started_flags` on `master_customer_id`.  
   - Counts distinct `feature_flag_id` for created, activated, and enabled states using conditional aggregation.

7. **Final SELECT** –  
   - Starts from `exp_total_experiments_started_flags` to retain one row per `mcid`.  
   - Left‑joins `total_experiments`, the three ranked rows from `combined` (r1, r2, r3), `digital_optimization_sku_owned`, and `flags_counts`.  
   - Calculates percentages of experiments per classification relative to the total.  
   - Derives human‑readable labels (`customer_breakdown`, `skus_owned`, `customer_category`).  
   - Computes `customer_breakdown_sub_category` based on the main percentage threshold.  

The CTE chain progressively aggregates and ranks experiment and flag data, then the final query merges these aggregates to produce a comprehensive per‑customer summary.

## Grain of Data  
The result set is at the **master‑customer (`mcid`)** level; each row represents one master customer with aggregated experiment and feature‑flag metrics.
