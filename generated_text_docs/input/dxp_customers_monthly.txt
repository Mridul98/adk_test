## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.dxp_customers_monthly

## Overview  
This model aggregates daily pageview and transaction metrics into monthly summaries per customer, calculating total counts, quantities, and average usage per customer for each unit of measure (pageviews or transactions).

## Tables Involved  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_appinsights_metrics`: source of daily pageview data.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_b2c_transactions`: source of daily transaction data.

## Columns Used  

**TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_appinsights_metrics**  
- `metrics_date` – date of the metric record.  
- `master_customer_id` – identifier of the customer.  
- `pageviews` – number of pageviews for the day.  
- `year_month` – derived month in `YYYY-MM` format.  
- `uom` – literal string `'pageviews'`.  
- `daily_aggregated_customers` – count of distinct customers per month.  
- `daily_aggregated_quantity` – sum of pageviews per month.  
- `usage_per_customer_daily` – average pageviews per customer per month.

**TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.stg_gtm_analytics_dxp_daily_b2c_transactions**  
- `metrics_date` – date of the metric record.  
- `master_customer_id` – identifier of the customer.  
- `transactions` – number of transactions for the day.  
- `year_month` – derived month in `YYYY-MM` format.  
- `uom` – literal string `'transactions'`.  
- `daily_aggregated_customers` – count of distinct customers per month.  
- `daily_aggregated_quantity` – sum of transactions per month.  
- `usage_per_customer_daily` – average transactions per customer per month.

## Logic Explanation  
1. **CTE `pageviews`** –  
   - Reads daily pageview metrics.  
   - Converts `metrics_date` to a `YYYY-MM` string (`year_month`).  
   - Aggregates per month: counts distinct `master_customer_id` as `daily_aggregated_customers`, sums `pageviews` as `daily_aggregated_quantity`, and calculates the average usage per customer (`usage_per_customer_daily`).  
   - Adds a constant `uom` column with value `'pageviews'`.  

2. **CTE `transactions`** –  
   - Reads daily transaction metrics.  
   - Performs the same monthly aggregation as `pageviews`, but on the `transactions` column.  
   - Adds a constant `uom` column with value `'transactions'`.  

3. **Final SELECT** –  
   - Combines the two monthly aggregates using `UNION ALL`.  
   - Orders the combined result by `year_month` descending and `uom` ascending.  

No joins or filters are applied; the model purely aggregates and merges two independent metric streams.

## Grain of Data  
Monthly aggregates per unit of measure (pageviews or transactions), i.e., one row per month per `uom`.
