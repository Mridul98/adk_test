## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.pipe_generation_bookings_opportunity

## Overview  
This model produces a deduplicated, opportunity‑centric view that combines account, contact, territory, financial, product, competition, partnership, source, campaign, and personnel information. It is intended for reporting and analysis of sales pipeline performance, revenue metrics, and account health.

## Tables Involved  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_partners`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_territory`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_currency_type`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_campaign`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_type_category`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_source_category`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_hierarchies`  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_leads`

## Columns Used  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users`:  
  - `id` – User identifier.  
  - `name` – User name.  
  - `user_role_id` – Foreign key to user role.  
  - `is_fivetran_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role`:  
  - `id` – Role identifier.  
  - `name` – Role name.  
  - `is_fivetran_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact`:  
  - `id` – Contact identifier.  
  - `is_deleted` – Deletion flag.  
  - `account_id` – Associated account.  
  - `name` – Contact name.  
  - `persona_c` – Persona.  
  - `lead_source` – Lead source.  
  - `lead_source_type_c` – Lead source type.  
  - `_fivetran_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account`:  
  - `account_id` – Account identifier.  
  - `master_customer_id` – Master customer ID.  
  - `account_name` – Account name.  
  - `icp_account` – ICP flag.  
  - `number_of_employees` – Employee count.  
  - `marketing_employees_counts` – Marketing employee count.  
  - `targeted_plays` – Targeted plays.  
  - `account_type` – Account type.  
  - `sub_industry` – Sub‑industry.  
  - `account_industry` – Industry.  
  - `territory` – Territory ID.  
  - `primary_account_executive_id` – Primary executive ID.  
  - `primary_customer_success_manager_id` – Primary CSM ID.  
  - `primary_contact` – Primary contact ID.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_partners`:  
  - `opportunity_id` – Opportunity identifier.  
  - `account_id` – Account identifier.  
  - `partner_type` – Partner type.  
  - `partner_role` – Partner role.  
  - `is_primary` – Primary partner flag.  
  - `is_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_territory`:  
  - `id` – Territory identifier.  
  - `name` – Territory name.  
  - `is_deleted` – Deletion flag.  
  - `is_fivetran_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_opportunity`:  
  - `opportunity_id` – Opportunity identifier.  
  - `account_id` – Account identifier.  
  - `territory_id` – Territory ID.  
  - `campaign_id` – Campaign identifier.  
  - `owner_id` – Owner user ID.  
  - `name` – Opportunity name.  
  - `type` – Opportunity type.  
  - `opportunity_source_c` – Opportunity source.  
  - `lead_source` – Lead source.  
  - `generated_by_c` – Generated by user ID.  
  - `date_entered_stage_discovery` – Discovery stage date.  
  - `date_entered_stage_closed_won` – Closed‑won stage date.  
  - `date_entered_stage_closed_won_finance` – Closed‑won finance stage date.  
  - `date_entered_stage_closed_lost` – Closed‑lost stage date.  
  - `date_entered_stage_sal_c` – SAL stage date.  
  - `date_entered_stage_sql_c` – SQL stage date.  
  - `date_entered_stage_accepted` – Accepted stage date.  
  - `date_entered_stage_proof_of_value` – Proof‑of‑value stage date.  
  - `date_entered_stage_proposal` – Proposal stage date.  
  - `date_entered_stage_contracts` – Contracts stage date.  
  - `date_entered_stage_prospecting` – Prospecting stage date.  
  - `customer_type` – Customer type.  
  - `stage_name` – Current stage name.  
  - `close_date` – Close date.  
  - `historical_current_contract_software_c` – Historical contract amount.  
  - `recurring_software_amount_new_rollup_c` – New roll‑up amount.  
  - `current_contract_software_new_c` – Current contract amount.  
  - `price_increase_software` – Price increase amount.  
  - `primary_competitor_c` – Primary competitor ID.  
  - `legacy_renewal_opportunity_new_c` – Legacy renewal flag.  
  - `custom_forecast_c` – Custom forecast value.  
  - `pipeline_influence` – Pipeline influence.  
  - `account_categorization` – Account categorization.  
  - `outbound_generated` – Outbound generated flag.  
  - `anchor_products` – Anchor product count.  
  - `meeting_booked_via` – Meeting booked via.  
  - `sub_territory` – Sub‑territory name.  
  - `exclude_from_sales_pipeline` – Exclusion flag.  
  - `currency_iso_code` – Currency ISO code.  
  - `is_fivetran_deleted` – Deletion flag.  
  - `is_deleted` – Deletion flag.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_currency_type`:  
  - `iso_code` – Currency ISO code.  
  - `conversion_rate_to_usd` – Conversion rate to USD.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_campaign`:  
  - `campaign_id` – Campaign identifier.  
  - `campaign_name` – Campaign name.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_type_category`:  
  - `opportunity_type` – Opportunity type key.  
  - `opportunity_type_category` – Category label.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_opportunity_source_category`:  
  - `opportunity_source` – Opportunity source key.  
  - `opportunity_source_category` – Source category label.  
  - `opportunity_source_category_grouping` – Source grouping label.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_hierarchies`:  
  - `territory_name` – Territory name.  
  - `segment` – Hierarchy segment.  
  - `region` – Region.  
  - `sub_region` – Sub‑region.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_leads`:  
  - `territory_name` – Territory name.  
  - `sub_territory_name` – Sub‑territory name.  
  - `territory_vp` – VP contact.  
  - `territory_svp` – SVP contact.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_hierarchies` (joined in final SELECT):  
  - `territory_name` – Territory name.  
  - `segment` – Hierarchy segment.  
  - `region` – Region.  
  - `sub_region` – Sub‑region.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.pipeline_territory_leads` (joined in final SELECT):  
  - `territory_name` – Territory name.  
  - `sub_territory_name` – Sub‑territory name.  
  - `territory_vp` – VP contact.  
  - `territory_svp` – SVP contact.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_currency_type` (used for recent currency rates):  
  - `iso_code` – Currency ISO code.  
  - `conversion_rate_to_usd` – Conversion rate to USD.  

## Logic Explanation  

1. **`sf_users`** – Pulls active users and joins to their role to expose `role_name`.  
2. **`sf_contact`** – Pulls active contacts.  
3. **`account`** – Pulls account details and enriches them with the primary executive, primary CSM, and primary contact information via joins to `sf_users` and `sf_contact`.  
4. **`partners`** – Aggregates primary partners per opportunity, concatenating partner account names, types, and roles into comma‑separated strings.  
5. **`territory`** – Retrieves territory identifiers and names for non‑deleted territories.  
6. **`primary_competitor`** – Extracts competitor account information from the account table.  
7. **`opportunity`** – Pulls opportunity data, calculates derived date parts (`close_date_year`, `close_date_month`, etc.), and computes `opp_rsac` using a CASE expression that subtracts historical contract amounts from the new roll‑up amount.  
8. **`recent_currency_rates`** – Loads currency ISO codes and USD conversion rates.  
9. **`joined_tables`** – Joins the opportunity CTE with campaign, account, partners, owner user, primary competitor, and generated‑by user. It also enriches opportunities with type and source categories from the pipeline dimension tables. The WHERE clause filters for:  
   - `opp_rsac > 0`  
   - `custom_forecast_c != 'Omitted'`  
   - `close_date >= '2020-01-01'`  
   - `legacy_renewal_opportunity_new_c` is NULL or `'No'`.  
10. **Final SELECT** – Projects a distinct, opportunity‑level snapshot. It joins `joined_tables` to:  
    - `recent_currency_rates` for currency conversion.  
    - `territory` for territory names.  
    - `pipeline_territory_hierarchies` for hierarchical segmentation.  
    - `pipeline_territory_leads` for lead‑based VP/SVP contacts, using `EQUAL_NULL` to handle NULL sub‑territory values.  

## Grain of Data  
The output is at the **opportunity** level; each row is uniquely identified by `opportunity_id`. The `DISTINCT` clause guarantees that each opportunity appears only once in the final result set.
