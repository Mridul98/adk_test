## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.exp_total_experiments_started_flags

## Overview  
This model aggregates customer experiment and feature‑flag activity across multiple time windows, combines it with account and ARR metrics, and flags low‑activity accounts. The result is an account‑level snapshot of engagement and revenue for use in dashboards or further analysis.

## Tables Involved  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics`: experiment activity data.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics`: feature‑flag activation data.  
- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail`: customer‑to‑account mapping.  
- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account`: Salesforce account details.  
- `REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report`: ARR and snapshot dates for experimentation products.

## Columns Used  

- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.experiment_metrics`:  
  - `customer_id` – identifier for the customer.  
  - `experiment_id` – identifier for an experiment.  
  - `experiment_start_time_impressions_reached` – timestamp when experiment impressions were reached.  

- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.feature_flags_metrics`:  
  - `customer_id` – identifier for the customer.  
  - `feature_flag_id` – identifier for a feature flag.  
  - `flag_activate` – timestamp when the flag was activated.  

- `REPORTING_DEV.DBT_MAHMUDNABI_opti_application.oa_customer_detail`:  
  - `customer_id` – identifier for the customer.  
  - `master_customer_id` – master customer identifier (used as `mcid`).  
  - `salesforce_account_id` – foreign key to Salesforce account.  

- `TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_account`:  
  - `account_id` – Salesforce account identifier.  
  - `account_name` – name of the account.  
  - `customer_stage` – sales stage of the account.  
  - `master_customer_id` – master customer identifier (used as `mcid`).  

- `REPORTING_DEV.DBT_MAHMUDNABI_arr_sst.arr_report`:  
  - `mcid` – master customer identifier.  
  - `snapshot_date` – date of the ARR snapshot.  
  - `updated_product_group` – product group (filtered to 'Web Experimentation' or 'Feature Experimentation').  
  - `arr_usd_ccfx` – ARR value in USD.  

- Derived columns (aliases):  
  - `experiment_started`, `flag_activate`, `experiments_started_all_time`, `experiments_started_last_30_days`, `experiments_started_last_90_days`, `flag_activate_last_30_days`, `flag_activate_all_time`, `started_less_than_10_experiments_flag`, `no_experiments_started_last_30_days_flag`, `no_experiments_started_last_90_days_flag`, `no_flag_activate_last_30_days_flag`, `less_than_10_flags_activate_all_time`, `earliest_exp_tat_date`, `latest_exp_tat_date`, `months_between_start_and_end_date`, `months_since_first_exp_product_identified_in_tat`, `arr`.

## Logic Explanation  
1. **experiment_metrics_90_days** – Counts distinct experiments started by each customer in the last 90 days.  
2. **feature_flags_metrics_30_days** – Counts distinct feature flags activated by each customer in the last 30 days.  
3. **experiment_metrics_30_days** – Counts distinct experiments started by each customer in the last 30 days.  
4. **feature_flags_metrics_all_time** – Counts distinct feature flags activated by each customer ever.  
5. **experiment_metrics_all_time** – Counts distinct experiments started by each customer ever.  

6. **experiment_started_all_time** – Joins `oa_customer_detail` with `experiment_metrics_all_time` and Salesforce account data. Aggregates the sum of all‑time experiments per account and flags accounts with fewer than 10 experiments.  

7. **experiment_started_last_30_days** – Similar to step 6 but uses 30‑day experiment counts and flags accounts with no experiments in the last 30 days.  

8. **experiment_started_last_90_days** – Similar to step 6 but uses 90‑day experiment counts and flags accounts with no experiments in the last 90 days.  

9. **first_arr** – From `arr_report`, groups by `mcid` to find the earliest and latest snapshot dates for experimentation products and calculates the month span between them.  

10. **current_arr** – Finds the most recent snapshot date before today, then sums ARR for each `mcid` on that date.  

11. **flag_activate_last_30_days** – Aggregates 30‑day feature‑flag activations per account and flags accounts with no activations in the last 30 days.  

12. **flag_activate_last_all_time** – Aggregates all‑time feature‑flag activations per account and flags accounts with fewer than 10 activations.  

13. **Final SELECT** – Left‑joins all the above CTEs on `mcid` (master customer id) to produce a single account‑level record. Adds a calculated field `months_since_first_exp_product_identified_in_tat` as the month difference between the earliest experimentation snapshot and the current date.

## Grain of Data  
The final result set is at the **account level** (one row per Salesforce account, identified by `salesforce_account_id` and `mcid`).
