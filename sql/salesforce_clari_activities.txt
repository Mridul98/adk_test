## Table Name: REPORTING_DEV.DBT_MAHMUDNABI_gtm_analytics.salesforce_clari_activities

## Overview  
This model extracts task‑level activity email information, enriches it with user role data to flag whether senders, receivers, or CC recipients are sales account executives (AE), and joins contact details. The result is a list of up to 500 tasks with aggregated email lists and AE indicators.

## Tables Involved  
- **TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.int_clari_activity_emails**: source activity email records.  
- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users**: Salesforce user lookup.  
- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role**: Salesforce role definitions.  
- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact**: Salesforce contact details.

## Columns Used  

- **TRANSFORM_DEV.DBT_MAHMUDNABI_gtm_analytics.int_clari_activity_emails**  
  - `activity_id` – unique identifier for the activity.  
  - `account_id` – identifier of the associated account.  
  - `who_id` – identifier of the primary contact or user.  
  - `what_id` – identifier of the related object (not used in final output).  
  - `sender_emails` – comma‑separated list of sender email addresses.  
  - `receiver_emails` – comma‑separated list of receiver email addresses.  
  - `cc_emails` – comma‑separated list of CC email addresses.  
  - `task_subject` – subject line of the task.  
  - `task_description` – description of the task.  
  - `"TASK"` – task type indicator.  
  - `task_action` – action required for the task.  
  - `is_reminder_set_for_task` – flag indicating if a reminder is set.  
  - `task_completed_date_time` – completion timestamp of the task.  
  - `owner_role_name_c` – owner role name (not used in final output).  

- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_users**  
  - `email` – user email address.  
  - `username` – user login name.  
  - `user_role_id` – foreign key to the role table.  

- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_user_role**  
  - `id` – role identifier.  
  - `rollup_description` – textual description of the role (used to detect sales roles).  

- **TRANSFORM_DEV.DBT_MAHMUDNABI_opti_salesforce.stg_opti_salesforce_contact**  
  - `id` – contact identifier.  
  - `name` – contact name.  
  - `email` – contact email address.  
  - `title` – contact job title.  

- **Derived / Aggregated Columns**  
  - `aggregated_senders.sender_emails` – aggregated list of distinct sender emails per activity.  
  - `aggregated_senders.sender_ae` – 'YES' if any sender has a sales role, else 'NO'.  
  - `aggregated_receivers.receiver_emails` – aggregated list of distinct receiver emails per activity.  
  - `aggregated_receivers.receiver_ae` – 'YES' if any receiver has a sales role, else 'NO'.  
  - `aggregated_ccs.cc_emails` – aggregated list of distinct CC emails per activity.  
  - `aggregated_ccs.ae_in_cc` – 'YES' if any CC recipient has a sales role, else 'NO'.  
  - `contact_id` – `COALESCE(_contacts.id, _maintask.who_id)` – primary contact id or fallback.  
  - `contact_name` – `_contacts.name`.  
  - `contcat_email` – `_contacts.email`.  
  - `contact_title` – `_contacts.title`.  

## Logic Explanation  
1. **Base Extraction (`main_tasks_info`)** – Pulls all relevant columns from `int_clari_activity_emails`.  
2. **Email Splitting** –  
   - `sender_emails`, `receiver_emails`, `cc_emails` CTEs split the comma‑separated email strings into individual rows using `LATERAL FLATTEN(SPLIT(...))`.  
3. **Role Determination** –  
   - `sender_roles`, `receiver_roles`, `cc_roles` join each split email with `stg_opti_salesforce_users` (matching on email or username) and then with `stg_opti_salesforce_user_role`.  
   - A CASE expression flags `sender_ae`, `receiver_ae`, `cc_ae` as 'YES' when the role description contains 'sales'.  
4. **Aggregation** –  
   - `aggregated_senders`, `aggregated_receivers`, `aggregated_ccs` regroup by `activity_id`, concatenate distinct emails into a single string, and set the AE flag to 'YES' if any member had a sales role.  
5. **Final Projection** –  
   - Left joins the aggregated email/AE data back to the base task records on `activity_id`.  
   - Joins `stg_opti_salesforce_contact` on `who_id` to enrich with contact details.  
   - Uses `COALESCE` to provide a fallback contact id if the contact lookup fails.  
6. **Limiting** – The query returns the first 500 rows of the resulting dataset.

## Grain of Data  
Each row represents a unique activity email (task) identified by `activity_id`. The data is aggregated at the task level, with email lists and AE flags consolidated per activity.
